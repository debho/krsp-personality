# MAIN FILE
# runs models once i have all the data cleaned and consolidated

# Analysis of survival
options(tidyverse.quiet = TRUE)
library(tidyverse)
library(lme4)
library(car)
library(DHARMa)
library(Matrix)

personality = read_csv('data/personality-mrw-survival.csv', show_col_types = FALSE) %>% 
  group_by(grid, year) %>% 
  mutate(growth_sc = scale(growth, scale = T, center = T)[,1],
         part_sc = scale(part, scale = T, center = T)[,1],
         gridyear = as.factor(gridyear),
         sex = as.factor(sex),
         year = as.factor(year),
         cohort = as.factor(cohort),
         grid = as.factor(grid),
         survived_200d = as.integer(survived_200d),
         made_it = as.integer(longevity >= 60)) %>%
  ungroup() 


aggression = personality %>% 
  select(front, back, attack, attacklatency, approachlatency) %>% 
  mutate(across(everything(), ~if_else(is.na(.x), median(.x, na.rm = TRUE), .x))) 

pca_agg = prcomp(aggression, scale = TRUE, center = TRUE)
mis1 = predict(pca_agg)[,1]

activity = personality %>% 
  select(walk, still, hang, jump, chew, hole, groom) %>% 
  mutate(across(everything(), ~if_else(is.na(.x), median(.x, na.rm = TRUE), .x)))

pca_act = prcomp(activity, scale = TRUE, center = TRUE)
oft1 = predict(pca_act)[,1]

personality$oft1 = unlist(oft1)
personality$mis1 = unlist(mis1)

# Survival to fall census -------------------------------------------------
dat = personality %>% 
  mutate(across(c(year, dam_id, litter_id, grid), as_factor))

survival_to_autumn = glmer(made_it ~ sex + 
                             scale(age_at_trial) + 
                             part_sc*scale(grid_density) +
                             growth_sc*scale(grid_density) + 
                             oft1*mis1*scale(grid_density) + 
                             grid +
                             mastyear + 
                             (1|year) + 
                             (1|dam_id) + 
                             (1|litter_id), 
                           data = dat,
                           na.action = 'na.omit',
                           family = binomial(link = "logit"),
                           control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e8)))

car::Anova(survival_to_autumn)
summary(survival_to_autumn)

# Diagnostics
simulationOutput = simulateResiduals(survival_to_autumn, plot = F)

residuals(simulationOutput, quantileFunction = qnorm)
plot(simulationOutput)
# Looks pretty good

# Model 2 Survival to 200 days --------------------------------------------
dat2 = personality %>% 
  mutate(across(c(year, dam_id, litter_id, grid), as_factor))

survival_to_200d = glmer(survived_200d ~ sex + 
                           scale(age_at_trial) + 
                           part_sc*scale(grid_density) +
                           growth_sc*scale(grid_density) + 
                           oft1*mis1*scale(grid_density) + 
                           grid +
                           mastyear +
                           (1|year) + 
                           (1|dam_id) + 
                           (1|litter_id),
                         data = dat2,
                         na.action = 'na.omit',
                         family = 'binomial',
                         control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e8)))
#allFit(mod)
car::Anova(survival_to_200d)
summary(survival_to_200d)

# Diagnostics
simulationOutput = simulateResiduals(survival_to_200d, plot = F)

residuals(simulationOutput, quantileFunction = qnorm)
plot(simulationOutput)
# Theres some wonkiness here with one of the random effects deviating
# But it seems to not be a massive issue
